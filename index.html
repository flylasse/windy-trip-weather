// UPDATED: Clean initialization - no auto-loading
let apiKey = localStorage.getItem('windyApiKey') || '';
let currentWeatherData = [];

// Load API key but don't auto-load anything
if (apiKey) {
    document.getElementById('apiKey').value = apiKey;
    debugLog('init', `API key loaded from storage: ${apiKey.substring(0, 8)}...`);
    // REMOVED: No auto-loading - user must click buttons explicitly
}

// UPDATED: Save API key without auto-loading
function saveApiKey() {
    const key = document.getElementById('apiKey').value.trim();
    if (key) {
        localStorage.setItem('windyApiKey', key);
        apiKey = key;
        showMessage('‚úÖ API key saved! Now you can load routes and get forecasts.', 'success');
        // REMOVED: No auto-loading after saving key
    } else {
        showMessage('Please enter a valid API key', 'error');
    }
}

// UPDATED: File input handling for both GPX and GPXD
document.addEventListener('DOMContentLoaded', function() {
    // GPX file input
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                debugLog('file-select', `GPX file selected: ${e.target.files[0].name}`);
                handleFile(e.target.files[0]);
            }
        });
    }
    
    // GPXD file input  
    const gpxdInput = document.getElementById('gpxdInput');
    if (gpxdInput) {
        gpxdInput.addEventListener('change', handleGPXDFile);
    }
    
    debugLog('init', 'Trip Weather app initialized - ready for user input');
});

// UPDATED: Handle both GPX and GPXD files
async function handleFile(file) {
    debugLog('file-upload', `Processing file: ${file.name}, size: ${file.size} bytes`);
    
    showLoading('üìÅ File selected, validating...', `Processing: ${file.name}`);
    
    if (!apiKey) {
        debugLog('api-check', 'No API key found', 'error');
        hideLoading();
        showMessage('Please enter your Windy API key first', 'error');
        return;
    }

    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.gpx') && !fileName.endsWith('.gpxd') && !fileName.endsWith('.xml')) {
        debugLog('file-validation', `Invalid file type: ${file.name}`, 'error');
        hideLoading();
        showMessage('Please upload a GPX, GPXD, or XML file', 'error');
        return;
    }

    try {
        updateProgress('üìñ Reading file contents...', 'Please wait...');
        await new Promise(resolve => setTimeout(resolve, 100));

        debugLog('file-read', 'Reading file content...');
        const text = await file.text();
        debugLog('file-content', `File content length: ${text.length} characters`);
        
        updateProgress('üó∫Ô∏è Parsing waypoints...', 'Analyzing route structure...');
        await new Promise(resolve => setTimeout(resolve, 200));
        
        debugLog('parsing-start', 'Starting GPX/GPXD parsing...');
        const waypoints = parseGPX(text);
        debugLog('parsing-complete', `Parsed ${waypoints.length} waypoints`);
        
        if (waypoints.length === 0) {
            debugLog('parsing-error', 'No waypoints found in file', 'error');
            hideLoading();
            showMessage('No waypoints found in file. Please check your file format.', 'error');
            return;
        }

        updateProgress('üå§Ô∏è Fetching today\'s weather forecasts...', `Found ${waypoints.length} waypoints`);
        await new Promise(resolve => setTimeout(resolve, 200));

        debugLog('weather-fetch-start', `Starting weather fetch for ${waypoints.length} waypoints`);
        await fetchWeatherForWaypoints(waypoints);
        
        const fileType = fileName.endsWith('.gpxd') ? 'GPXD' : 'GPX';
        showMessage(`‚úÖ Loaded ${waypoints.length} waypoints from ${fileType} file. Now adjust dates as needed!`, 'success');
        
    } catch (error) {
        debugLog('file-error', error, 'error');
        console.error('Error processing file:', error);
        hideLoading();
        showMessage('Error processing file: ' + error.message, 'error');
    }
}

// UPDATED: Test API with clear feedback
async function testApiKey() {
    if (!apiKey) {
        showMessage('Please enter and save your API key first', 'error');
        return;
    }

    showLoading('üß™ Testing API key...', 'Checking San Francisco weather...');
    
    try {
        // Test with San Francisco coordinates for today
        const testWeather = await fetchWeatherData(37.7749, -122.4194, new Date());
        hideLoading();
        showMessage(`‚úÖ API test successful! SF today: ${testWeather.temperature}¬∞C, ${testWeather.windSpeed} km/h wind`, 'success');
        debugLog('api-test', 'API test successful', testWeather);
    } catch (error) {
        hideLoading();
        showMessage(`‚ùå API test failed: ${error.message}`, 'error');
        debugLog('api-test', 'API test failed', 'error');
        console.error('API test error:', error);
    }
}